name: Image Synchronization

on:
  push:
    branches: [ main ]
    paths:
    - 'images.yaml'

jobs:
  push-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Login to Aliyun Registry
      uses: docker/login-action@v1
      with:
        mode: login
        registry: ${{ secrets.REGISTRY }}  
        username: ${{ secrets.REGISTRY_USER }} 
        password: ${{ secrets.REGISTRY_PASSWORD }} 

    - name: Push Image and Generate Report
      id: push-image
      run: chmod +x ./app.sh && ./app.sh
      env:
        REGISTRY: ${{ secrets.REGISTRY }}
        NAMESPACE: ${{ secrets.REGISTRY_NAMESPACE }}
    
    - name: Upload Log Files
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sync-logs
        path: |
          image_sync_*.log
          image_sync_*_success.log
          image_sync_*_errors.log
    
    - name: Parse and Send Notification
      if: always()
      run: |
        # æŸ¥æ‰¾æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶
        LATEST_LOG=$(ls -t image_sync_*.log | head -1)
        LATEST_SUCCESS=$(ls -t image_sync_*_success.log | head -1)
        LATEST_ERROR=$(ls -t image_sync_*_errors.log | head -1)
        
        # æå–ç»Ÿè®¡ä¿¡æ¯
        TOTAL=$(grep "æ€»è®¡å¤„ç†" "$LATEST_LOG" | awk '{print $3}' || echo "æœªçŸ¥")
        SUCCESS=$(grep "æˆåŠŸ:" "$LATEST_LOG" | awk '{print $2}' || echo "0")
        FAILED=$(grep "å¤±è´¥:" "$LATEST_LOG" | awk '{print $2}' || echo "0")
        
        # è·å–æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
        SUCCESS_IMAGES=$(sed -n '/æˆåŠŸé•œåƒåˆ—è¡¨:/,/å¤±è´¥:/{/æˆåŠŸé•œåƒåˆ—è¡¨:/!{/å¤±è´¥:/!p}}' "$LATEST_LOG" | grep "^-" | sed 's/^  - //' | tr '\n' ',' | sed 's/,$//' || echo "æ— ")
        FAILED_IMAGES=$(sed -n '/å¤±è´¥é•œåƒåˆ—è¡¨:/,/exit/{/å¤±è´¥é•œåƒåˆ—è¡¨:/!{/exit/!p}}' "$LATEST_LOG" | grep "^-" | sed 's/^  - //' | tr '\n' ',' | sed 's/,$//' || echo "æ— ")
        
        # æ„å»ºMarkdownæ ¼å¼çš„æ¶ˆæ¯
        STATUS=$([ "${{ job.status }}" == "success" ] && echo "âœ…" || echo "âŒ")
        TITLE="$STATUS é•œåƒåŒæ­¥å®Œæˆ - ${{ job.status }}"
        
        MESSAGE="## ğŸ“¦ é•œåƒåŒæ­¥æŠ¥å‘Š
**ä»“åº“:** ${{ github.repository }}  
**åˆ†æ”¯:** ${{ github.ref }}  
**æäº¤è€…:** ${{ github.actor }}  
**æ‰§è¡ŒçŠ¶æ€:** ${{ job.status }}  

### ğŸ“Š åŒæ­¥ç»Ÿè®¡
- **æ€»è®¡å¤„ç†:** $TOTAL ä¸ªé•œåƒ
- **æˆåŠŸåŒæ­¥:** $SUCCESS ä¸ª
- **åŒæ­¥å¤±è´¥:** $FAILED ä¸ª

### âœ… æˆåŠŸé•œåƒ
$(if [ "$SUCCESS" -gt 0 ]; then 
  echo "$SUCCESS_IMAGES" | tr ',' '\n' | sed 's/^/- /'
else
  echo "- æ— "
fi)

### âŒ å¤±è´¥é•œåƒ
$(if [ "$FAILED" -gt 0 ]; then 
  echo "$FAILED_IMAGES" | tr ',' '\n' | sed 's/^/- /'
else
  echo "- æ— "
fi)

### ğŸ”— è¯¦ç»†ä¿¡æ¯
- **æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S')
- **å·¥ä½œæµè¯¦æƒ…:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
- **æ—¥å¿—ä¸‹è½½:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"

        # å‘é€åˆ°å¾®ä¿¡
        curl -X POST \
          -d "title=$TITLE" \
          -d "desp=$MESSAGE" \
          "https://sctapi.ftqq.com/${{ secrets.SERVER_JIAN_SENDKEY }}.send"
