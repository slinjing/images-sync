name: Image Sync

on:
  push:
    branches: [ main ]
    paths: [ 'images.yaml' ]
  workflow_dispatch:

jobs:
  push-image:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 缩短超时（并行处理更快）

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4  # 升级到最新版（性能优化）

      - name: 安装并行工具
        run: sudo apt-get update && sudo apt-get install -y parallel  # 安装GNU Parallel

      - name: 配置Docker加速（关键！提升拉取/推送速度）
        run: |
          # 增加Docker并发下载/上传层数（默认2层，改为5层）
          echo '{"max-concurrent-downloads": 5, "max-concurrent-uploads": 5}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Login to Registry
        uses: docker/login-action@v3  # 升级到最新版（支持更多优化）
        with:
          registry: ${{ secrets.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: 并行同步镜像
        run: |
          chmod +x ./app.sh
          ./app.sh
        env:
          REGISTRY: ${{ secrets.REGISTRY }}
          NAMESPACE: ${{ secrets.REGISTRY_NAMESPACE }}

      - name: 输出成功日志
        if: success()
        run: cat succeeded.log

      - name: 输出失败日志
        if: failure()
        run: cat failed.log
