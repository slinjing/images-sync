name: Image Synchronization

on:
  push:
    branches: [ main ]
    paths:
    - 'images.yaml'

jobs:
  push-image:
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.sync-images.outputs.summary }}
      success_count: ${{ steps.sync-images.outputs.success_count }}
      failed_count: ${{ steps.sync-images.outputs.failed_count }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Login to Aliyun Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.REGISTRY }}  
        username: ${{ secrets.REGISTRY_USER }} 
        password: ${{ secrets.REGISTRY_PASSWORD }} 

    - name: Sync Images
      id: sync-images
      run: |
        chmod +x ./app.sh
        # æ‰§è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
        OUTPUT=$(./app.sh 2>&1)
        EXIT_CODE=$?
        
        # æå–æ±‡æ€»ä¿¡æ¯
        SUMMARY=$(echo "$OUTPUT" | grep -A 10 "4. åŒæ­¥ç»“æœæ±‡æ€»:" || echo "æ— æ³•æå–æ±‡æ€»ä¿¡æ¯")
        SUCCESS_COUNT=$(echo "$SUMMARY" | grep "æˆåŠŸ:" | awk '{print $2}' || echo "0")
        FAILED_COUNT=$(echo "$SUMMARY" | grep "å¤±è´¥:" | awk '{print $2}' || echo "0")
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
        
        # è¾“å‡ºå®Œæ•´æ—¥å¿—
        echo "$OUTPUT"
        exit $EXIT_CODE
      env:
        REGISTRY: ${{ secrets.REGISTRY }}
        NAMESPACE: ${{ secrets.REGISTRY_NAMESPACE }}

    # æ·»åŠ æˆåŠŸåçš„é€šçŸ¥æ­¥éª¤
    - name: Send success notification to WeChat
      if: success()
      run: |
        # ç¾åŒ–æ¶ˆæ¯æ ¼å¼
        MESSAGE="ğŸ·ï¸ **âœ… é•œåƒåŒæ­¥æˆåŠŸ**
        
        ğŸ“¦ **ä»“åº“ä¿¡æ¯**
        â€¢ ä»“åº“: ${{ github.repository }}
        â€¢ åˆ†æ”¯: ${{ github.ref }}
        â€¢ æäº¤è€…: ${{ github.actor }}
        â€¢ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
        
        â° **æ‰§è¡Œæ—¶é—´**
        â€¢ $(date +'%Y-%m-%d %H:%M:%S')
        
        ğŸ“Š **åŒæ­¥ç»“æœ**
        ${{ steps.sync-images.outputs.summary }}
        
        ğŸ”— **è¯¦æƒ…é“¾æ¥**
        â€¢ https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # å‘é€åˆ°å¾®ä¿¡
        curl -X POST \
          -d "title=âœ… é•œåƒåŒæ­¥æˆåŠŸ (${{ steps.sync-images.outputs.success_count }}æˆåŠŸ/${{ steps.sync-images.outputs.failed_count }}å¤±è´¥)" \
          -d "desp=$MESSAGE" \
          "https://sctapi.ftqq.com/${{ secrets.SERVER_JIAN_SENDKEY }}.send"

  # æ·»åŠ ä¸“é—¨çš„é€šçŸ¥jobï¼Œå¤„ç†å¤±è´¥æƒ…å†µ
  notify-failure:
    runs-on: ubuntu-latest
    needs: push-image
    if: failure()  # åªæœ‰push-imageå¤±è´¥æ—¶æ‰è¿è¡Œ
    steps:
      - name: Send failure notification to WeChat
        run: |
          # ç¾åŒ–æ¶ˆæ¯æ ¼å¼
          MESSAGE="ğŸ·ï¸ **âŒ é•œåƒåŒæ­¥å¤±è´¥**
          
          ğŸ“¦ **ä»“åº“ä¿¡æ¯**
          â€¢ ä»“åº“: ${{ github.repository }}
          â€¢ åˆ†æ”¯: ${{ github.ref }}
          â€¢ æäº¤è€…: ${{ github.actor }}
          â€¢ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
          
          â° **æ‰§è¡Œæ—¶é—´**
          â€¢ $(date +'%Y-%m-%d %H:%M:%S')
          
          ğŸ“Š **åŒæ­¥ç»“æœ**
          ${{ needs.push-image.outputs.summary }}
          
          ğŸ› **é”™è¯¯ä¿¡æ¯**
          â€¢ è¯·æŸ¥çœ‹GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
          
          ğŸ”— **è¯¦æƒ…é“¾æ¥**
          â€¢ https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST \
            -d "title=âŒ é•œåƒåŒæ­¥å¤±è´¥ (${{ needs.push-image.outputs.success_count }}æˆåŠŸ/${{ needs.push-image.outputs.failed_count }}å¤±è´¥)" \
            -d "desp=$MESSAGE" \
            "https://sctapi.ftqq.com/${{ secrets.SERVER_JIAN_SENDKEY }}.send"
